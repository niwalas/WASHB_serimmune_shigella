---
title: "2-shigella_epitope_summary"
author: "Niko Walas"
date: "2024-05-30"
output: 
  html_document:
    theme: default
    highlight: default
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

# File description: 
This is a summary analysis of protein and pathogen level response for Shigella sonnei Ipa proteins. Samples were coded positive to a protein if it had at least one epitope and positive to the pathogen if it had at least two epitope hits across all proteins in the panel. 

# Output
This file outputs multiple figures for overview analyses. Specifically, in section 4B the figures used in figure 3 of the manuscript are generated. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = T,
  warning = F,
  message = F
)
source(here::here("R/0-config.R"))
library(kableExtra)
```

# Read in inital summary
```{r}
shig_sum_prot <- read.csv(here("data/shigella_ipa_sum_prot.csv")) 
shig_sum_path <- read.csv(here("data/shigella_ipa_sum_path.csv")) %>% mutate(visit_2 = case_when(visit == "Visit 1" ~ "3 months", 
                                              visit == "Visit 2" ~ "14 months", 
                                              TRUE ~ "28 months"))
shig_sum_path$visit_2 <- factor(shig_sum_path$visit_2, levels = c("3 months", 
                                                                  "14 months", 
                                                                  "28 months"))

metadata <- read.csv(here("data/washb-serimmune-metadata-230616.csv"))
```

# 1) Protein Level Analysis 

## a) Calculate protein seroprevalence for subset
```{r}
#seropositivity by each protein 
prot_pos <- shig_sum_prot %>% group_by(protein, time_point) %>% 
  summarise(perc_pos = round(sum(sero_pos == "POS", na.rm = T)/length(sero_pos)*100, 2))  %>% pivot_wider(names_from = time_point, values_from = perc_pos) 
```


## b) Plot protein seroprevalence
```{r}
#rework the dataframe for the plot
df1 <- prot_pos %>% pivot_longer(cols = 2:4, names_to = "timepoint", values_to = "prev") 
order <- c("1", "2", "3")
df1$timepoint <- factor(df1$timepoint, levels=order)

df1 %>% filter(str_detect(protein, "ipa")) %>% 
  ggplot(aes(x = timepoint, y = prev, group = protein)) + 
  geom_point() + 
  geom_line() + 
  ylim(0, 100) +
  theme_minimal()  + 
  facet_wrap(~ protein, ncol = 4) +
  labs(x = "Timepoint", y = "Prevalence", title = "Seroprevalence to Shigella IpA Proteins")
ggsave("../output/figures/ssonnei_ipa_seroprev.png", width = 10, height = 6)
```

# 2) IWAS HeatMaps
```{r}
order <- c("1", "2", "3")
shig_IWAS_2 <- shig_sum_prot %>% arrange(time_point)
shig_IWAS_2$time_point <- factor(shig_IWAS_2$time_point, levels=order)

#heatmap with x-axis ordered according to time visit 
#check range of scores to set the heatmap values
range(shig_IWAS_2$mean_IWAS)
#will set at -0.6 and 0.8

#plot heatmap  
visit_1 <- shig_IWAS_2 %>% filter(time_point == "1") %>% arrange(SampleID) %>% ungroup()
visit_2 <- shig_IWAS_2 %>% filter(time_point == "2") %>% arrange(SampleID) %>% ungroup()
visit_3 <- shig_IWAS_2 %>% filter(time_point == "3") %>% arrange(SampleID) %>% ungroup()
aggregate <- visit_1 %>% bind_rows(visit_2) %>% bind_rows(visit_3) 

#Have to manually add levels to the order otherwise ggplot groups by sampleID!!
order <- unique(aggregate$SampleID)
aggregate$SampleID <- factor(aggregate$SampleID, levels=order)

aggregate %>% 
  ggplot(aes(x = SampleID, y = protein, fill = mean_IWAS)) +
  geom_tile() +
  annotate("text", label = "Visit 1", 
           x = head(visit_1$SampleID, n=1), 
           y = -Inf, 
           hjust = -1, 
           vjust = 1.5, size = 3.5, colour = "black")  +
  annotate("text", label = "Visit 2", 
           x = head(visit_2$SampleID, n=1), 
           y = -Inf, 
           hjust = -1, 
           vjust = 1.5, 
           size = 3.5, 
           colour = "black") +
  annotate("text", label = "Visit 3", 
           x = head(visit_3$SampleID, n=1), 
           y = -Inf, 
           hjust = -1, 
           vjust = 1.5,
           size = 3.5, 
           colour = "black") +
  geom_vline(xintercept = tail(visit_1$SampleID, n=1), color = "white", lwd = 1) +
  geom_vline(xintercept = tail(visit_2$SampleID, n=1), color = "white", lwd = 1) +
  scale_fill_viridis(limits = c(-0.6, 0.8), oob = scales::squish) + 
  theme_minimal() + 
  labs(title = "Mean IWAS over seroreactive regions", 
       x = "\nSampleID", 
       y = "Protein", 
       fill = "mean_IWAS") +
  theme(axis.text.y = element_text(hjust = 1), 
       axis.text.x = element_blank(), 
       legend.position="bottom") 
#ggsave("../output/1-heatmap_aggregate_meanIWAS.png", width = 10, height = 7)

range(shig_IWAS_2$max_IWAS)
aggregate %>% 
  ggplot(aes(x = SampleID, y = protein, fill = max_IWAS)) +
  geom_tile() +
  annotate("text", label = "Visit 1", 
           x = head(visit_1$SampleID, n=1), 
           y = -Inf, 
           hjust = -1, 
           vjust = 1.5, size = 3.5, colour = "black")  +
  annotate("text", label = "Visit 2", 
           x = head(visit_2$SampleID, n=1), 
           y = -Inf, 
           hjust = -1, 
           vjust = 1.5, 
           size = 3.5, 
           colour = "black") +
  annotate("text", label = "Visit 3", 
           x = head(visit_3$SampleID, n=1), 
           y = -Inf, 
           hjust = -1, 
           vjust = 1.5,
           size = 3.5, 
           colour = "black") +
  geom_vline(xintercept = tail(visit_1$SampleID, n=1), color = "white", lwd = 1) +
  geom_vline(xintercept = tail(visit_2$SampleID, n=1), color = "white", lwd = 1) +
  scale_fill_viridis(limits = c(-0.3, 15), oob = scales::squish) + 
  theme_minimal() + 
  labs(title = "Max IWAS over seroreactive regions", 
       x = "\nSampleID", 
       y = "Protein", 
       fill = "max_IWAS") +
  theme(axis.text.y = element_text(hjust = 1), 
       axis.text.x = element_blank(), 
       legend.position="bottom") 
ggsave("../output/figures/heatmap_aggregate_maxIWAS.png", width = 10, height = 7)
```

# 3) Correlation of antigens
```{r}
library(ggcorrplot)

#make into matrix format
shig_hc <- shig_sum_prot %>% select(SampleID, protein, mean_IWAS) %>% 
  pivot_wider(names_from = protein, values_from = mean_IWAS) #make it into matrix format

shig_cor <- shig_hc %>% select(-SampleID)
corr <- cor(shig_cor, method = "pearson")

plot_corr <- ggcorrplot(corr, 
                        legend.title = "Correlation", 
                        lab = TRUE) + 
  theme(legend.position = "top", 
        plot.margin = (unit(c(5.5, 1, 5.5, 5.5), "pt"))
        )

plot_corr
ggsave("../output/figures/ssonnei_corr_proteins.png", width = 10, height = 10)
```

# 4) Pathogen Level Summary 

## a) Summary measures processing
```{r}
path_pos <- shig_sum_path %>% 
  group_by(sero_pos_final, time_point) %>% 
  summarise(count_protein_positive = n()) %>% 
  pivot_wider(names_from = sero_pos_final, values_from = count_protein_positive) %>% 
  mutate(total = NEG + POS, 
         percent_pos = round(POS/total*100, 2))

```

## b) Breadth: Plot histogram of number of proteins that were positive
```{r}
#histogram of distribution of proteins positive to 
breaks <- 0:23
ggplot(shig_sum_path, aes(x = protein_count, fill = visit_2)) +
  geom_bar()  +
  theme(axis.text.x = element_text(angle=45, hjust = 1), 
        panel.background = element_rect(fill = "white"), 
        panel.grid = element_line(color = 'grey', 
                                  linewidth = 0.25), 
        legend.position = "none", 
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        axis.ticks.x = element_line(color = "black", size = 0.5), text = element_text(size = 20))  + 
  scale_fill_manual(values = cbpal[2:4]) +
  labs(y = "Count of Samples", 
       x = "Number of Ipa proteins with >= 1 epitope hit") +  
       #title = "Distribution of Shigella Ipa Protein Positivity") +
  scale_x_continuous(breaks = breaks) + facet_wrap(~visit_2, ncol = 1)
ggsave("../figures/fig3_ssonnei_protein_pos_count.png", width = 7, height = 7)

#histogram of distribution of epitope hits across proteins

ggplot(shig_sum_path, aes(x = epitope_count, fill = visit,group = as.character(visit_2))) +
  geom_bar()  +
  scale_fill_manual(values = cbpal[2:4]) +
  theme(axis.text.x = element_text(angle=45, hjust = 1), 
        panel.background = element_rect(fill = "white"), 
        panel.grid = element_line(color = 'grey', 
                                  linewidth = 0.25), 
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        axis.ticks.x = element_line(color = "black", size = 0.5), 
        legend.position = "none", 
        text = element_text(size = 20)) + 
  labs(y = "Count of Samples", 
       x = "Number of epitope hits across all 5 Ipa proteins") + 
       #title = "Distribution of Shigella Epitope Hits Across Ipa Proteins") + 
scale_x_continuous(breaks = breaks) + facet_wrap( ~visit_2, ncol = 1) +
  coord_cartesian(xlim = c(0, 12))

ggsave("../figures/fig3_ssonnei_ep_hit_dis_pos.png", width = 7, height = 7)

# what if smoothed the barcharts? 
#protein count
ggplot(shig_sum_path, aes(x = protein_count, fill = visit_2, color = visit_2)) +
  geom_density(alpha = 0.4, adjust = 2)  +
  theme(axis.text.x = element_text(angle=45, hjust = 1), 
        panel.background = element_rect(fill = "white"), 
        panel.grid = element_line(color = 'grey', 
                                  linewidth = 0.25), 
        legend.position = "top", 
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        axis.ticks.x = element_line(color = "black", size = 0.5), text = element_text(size = 20))  + 
  scale_fill_manual(values = cbpal[2:4]) +
  scale_color_manual(values = cbpal[2:4]) + 
  labs(y = "Density of samples", 
       x = "Number of Ipa proteins with >= 1 epitope hit", 
      fill = "Age", 
      color = "Age") +  
  scale_x_continuous(breaks = breaks) 
#ggsave("../figures/fig3_ssonnei_protein_pos_countdensity.png", width = 10, height = 7)

# epitope count
ggplot(shig_sum_path, aes(x = epitope_count, fill = visit_2, color = visit_2)) +
  geom_density(alpha = 0.4, adjust = 2)  +
  scale_fill_manual(values = cbpal[2:4]) +
  scale_color_manual(values = cbpal[2:4]) + 
  scale_x_continuous(breaks = breaks, limits = c(0, 12)) + 
  theme(axis.text.x = element_text(angle=45, hjust = 1), 
        panel.background = element_rect(fill = "white"), 
        panel.grid = element_line(color = 'grey', 
                                  linewidth = 0.25), 
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        axis.ticks.x = element_line(color = "black", size = 0.5), 
        legend.position = "top", 
        text = element_text(size = 20)) + 
  labs(y = "Count of Samples", 
       x = "Number of epitope hits across all 5 Ipa proteins", 
       fill = "Age", 
       color = "Age")
#ggsave("../output/fig2_ssonnei_ep_hit_dis_pos_density.png", width = 10, height = 7)
```

## c) Calculate pathogen level seroprevalence 
```{r}
#Plot of positivity rates depending on threshold
path_pos %>% 
  ggplot(aes(x = time_point, y = percent_pos)) + 
  geom_point() + 
  geom_line() + 
  ylim(0, 100) +
  theme_minimal()  +
  labs(x = "Timepoint", y = "IgG Seroprevalence", title = "Seroprevalence to Shigella sonnei Pathogen")

ggsave("../output/figures/ssonnei_seropos_threshold.png", width = 10, height = 7)
```

# 5) IWAS distribution of seropositive groups
```{r}
#mean_IWAS accross proteins
p1 <- ggplot(shig_sum_path, aes(x = time_point, y = mean_IWAS, group = time_point))  +
  geom_boxplot(notch=F, outlier.shape = NA) +
  geom_jitter(aes(color = sero_pos_final, group = time_point), width = 0.25, size = 1.2) +
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_line(color = "grey90"),
    panel.grid.minor = element_line(color = "grey95")
  )  + 
  labs(title = str_wrap("meanIWAS across all 5 Ipa proteins", 
                        width = 60), 
       x = "timepoint",
       y = "MeanIWAS over all seroreactive regions") +
  scale_color_manual(values = c("darkblue", "lightblue"))
p1
#ggsave("../output/figures/shig_ipa_path_meanIWAS.png", height = 4, width = 6)

#max_IWAS accross proteins
p2 <- ggplot(shig_sum_path, aes(x = time_point, y = max_IWAS, group = time_point))  +
  geom_boxplot(notch=F, outlier.shape = NA) +
  geom_jitter(aes(color = sero_pos_final, group = time_point), width = 0.25, size = 1.2) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_line(color = "grey90"),
    panel.grid.minor = element_line(color = "grey95")
  )  + 
  labs(title = str_wrap("maxIWAS across all 5 Ipa proteins", 
                        width = 60), 
       x = "timepoint",
       y = "MaxIWAS over all seroreactive regions") +
  scale_color_manual(values = c("darkblue", "lightblue"))
p2
#ggsave("../output/figures/shig_ipa_path_maxIWAS.png", height = 4, width = 6)

#sum_IWAS accross proteins
p3 <- ggplot(shig_sum_path, aes(x = time_point, y = sum_IWAS))  +
  geom_boxplot(notch=F) +
  geom_jitter(aes(color = sero_pos_final), width = 0.25, size = 1.2) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_line(color = "grey90"),
    panel.grid.minor = element_line(color = "grey95")
  )  + 
  labs(title = str_wrap("sumIWAS across all 5 Ipa proteins", 
                        width = 60), 
       x = "timepoint",
       y = "sumIWAS over all seroreactive regions") +
  scale_color_manual(values = c("darkblue", "lightblue"))
ggsave("../output/figures/shig_ipa_path_sumIWAS.png")

#combine for one figure 
library(cowplot)
plot_grid(p1, p2, ncol=1)
ggsave("../output/figures/shig_ipa_path_mean_max_IWAS.png", height = 8, width = 7)


#epitope count
ggplot(shig_sum_path, aes(x = time_point, y = epitope_count))  +
  geom_boxplot(notch=F) +
  geom_jitter(aes(color = sero_pos_final), width = 0.25, size = 1.2) + facet_wrap(~ time_point)

#protein count
ggplot(shig_sum_path, aes(x = time_point, y = protein_count))  +
  geom_boxplot(notch=F) +
  geom_jitter(aes(color = sero_pos_final), width = 0.25, size = 1.2) + facet_wrap(~ time_point)

```

# 6) Timepoint based analysis 
```{r}
# rework the meta data so it is in a format to merge with the IWAS level data
meta_base <- metadata %>% select(sampleid_base, agedays_base) %>% rename(SampleID = sampleid_base, age_days = agedays_base)
meta_mid <- metadata %>% select(sampleid_mid, agedays_mid) %>% rename(SampleID = sampleid_mid, age_days = agedays_mid)
meta_end <- metadata %>% select(sampleid_end, agedays_end) %>% rename(SampleID = sampleid_end, age_days = agedays_end)

# merge to the IWAS data along with the protein positivity data
meta_ages <- rbind(meta_base, meta_mid, meta_end)
IWAS_meta <- shig_IWAS_2 %>% merge(meta_ages, by = "SampleID") %>% mutate(HHID = str_sub(SampleID, start = 1, end = -4))
path_meta <- shig_sum_path %>% merge(meta_ages, by = "SampleID") %>% mutate(HHID = str_sub(SampleID, start = 1, end = -4))
```

# 7) Plot time based quantitative measures
```{r}
#protein level 
IWAS_meta %>% ggplot(aes(x = age_days, y = mean_IWAS))+
  geom_smooth() + 
  #ylim(-0.5, 0.5) +
  theme_minimal()  +
  labs(x = "Age in Days", y = "Mean IWAS- seroreactive regions", title = "Mean IWAS in Seroreactive Regions, Ipa Proteins") + 
  facet_wrap(~ protein, scales = "free_y")

#pathogen level
path_meta %>% ggplot(aes(x = age_days, y = mean_IWAS))+
  geom_smooth() +
 # geom_point() +#changes the scale quite a bit so that the trend is diminished- does this mean something?
  #ylim(-0.5, 0.5) +
  theme_minimal()  +
  labs(x = "Age in Days", y = "Mean IWAS- seroreactive regions", title = "Mean IWAS in Seroreactive Regions Across 5 Ipa Proteins") 

#pathogen level
path_meta %>% ggplot(aes(x = age_days, y = epitope_count))+
  geom_smooth() +
 geom_point() +
  #ylim(-0.5, 0.5) +
  theme_minimal()  +
  labs(x = "Age in Days", y = "Epitope count- seroreactive regions", title = "Count of epitopes Across 5 Ipa Proteins") 
```
